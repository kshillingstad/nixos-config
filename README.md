# NixOS Multi-Machine Configuration

This repository contains a structured NixOS configuration that can be deployed across multiple machines.

## Structure

```
├── base.nix                    # Shared base configuration
├── flake.nix                   # Flake configuration with active hosts
├── modules/                    # Reusable modules
│   ├── desktop.nix            # Desktop environment setup
│   ├── devtools.nix           # Development tools
│   ├── sunshine.nix           # Sunshine streaming server
│   └── kernel.nix             # Kernel configuration
└── hosts/                     # Machine-specific configurations
    ├── bfgpu/                 # High-performance workstation with NVIDIA + desktop + sunshine
    │   ├── default.nix
    │   └── hardware-configuration.nix
    ├── surface/               # Microsoft Surface laptop with Surface-specific tweaks
    │   ├── default.nix
    │   └── hardware-configuration.nix
    └── threadripper/          # Headless compute + ZFS + NVIDIA container
        ├── default.nix
        └── hardware-configuration.nix
```

## Adding a New Machine

1. **Generate hardware configuration:**
   ```bash
   sudo nixos-generate-config --dir /tmp/new-machine
   ```

2. **Create host directory:**
   ```bash
   mkdir hosts/new-machine-name
   cp /tmp/new-machine/hardware-configuration.nix hosts/new-machine-name/
   ```

3. **Create host configuration:**
   ```bash
   cp hosts/laptop/default.nix hosts/new-machine-name/
   # Edit the file to set hostname and machine-specific settings
   ```

4. **Add to flake.nix:**
   ```nix
   nixosConfigurations = {
     # ... existing configs
     new-machine-name = nixpkgs.lib.nixosSystem {
       modules = [
         ./base.nix
         ./hosts/new-machine-name
         chaotic.nixosModules.default
       ];
     };
   };
   ```

## Building and Switching

**For current machine:**
```bash
sudo nixos-rebuild switch --flake .#hostname
```

**For remote deployment:**
```bash
nixos-rebuild switch --flake .#hostname --target-host user@hostname --use-remote-sudo
```

**Build without switching (test):**
```bash
sudo nixos-rebuild build --flake .#hostname
```

## Current Machines

- **bfgpu**: High-performance workstation with NVIDIA GPU, full desktop environment (Wayland/GNOME), sunshine streaming server
- **surface**: Microsoft Surface laptop with Surface-specific kernel (stable), NVIDIA GPU support, Firefox, full desktop environment (Wayland/GNOME)  
- **threadripper**: Headless compute box with ZFS pool (Storage), NVIDIA open kernel driver + container toolkit for GPU workloads, Docker with GPU passthrough

## Maintenance Commands

### Updating flake inputs
```bash
nix flake update
```

### List generations
```bash
nix-env --list-generations
```

### Garbage collection
```bash
nix-collect-garbage --delete-old
# or for specific generations
nix-collect-garbage --delete-generations 1 2 3

# Run as sudo to collect additional garbage
sudo nix-collect-garbage -d
```

### Clean boot entries
```bash
sudo /run/current-system/bin/switch-to-configuration boot
```

## Notes

- Each machine needs its own `hardware-configuration.nix` generated by `nixos-generate-config`
- LUKS UUIDs are machine-specific and must be updated in each host config
- User configuration centralized in modules/user-kyle.nix
- The base configuration includes common settings like timezone, locale, and basic services