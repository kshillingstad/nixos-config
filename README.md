# NixOS Multi-Machine Configuration

This repository contains a structured NixOS configuration that can be deployed across multiple machines.

## Structure

```
├── base.nix                    # Shared base configuration
├── flake.nix                   # Flake configuration with active hosts
├── modules/                    # Reusable modules
│   ├── desktop.nix            # Desktop environment setup
│   ├── devtools.nix           # Development tools
│   ├── sunshine.nix           # Sunshine streaming server
│   └── kernel.nix             # Kernel configuration
└── hosts/                     # Machine-specific configurations
    ├── bfgpu/                 # High-performance workstation with NVIDIA + desktop + sunshine
    │   ├── default.nix
    │   └── hardware-configuration.nix
    ├── surface/               # Microsoft Surface laptop with Surface-specific tweaks
    │   ├── default.nix
    │   └── hardware-configuration.nix
    └── threadripper/          # Headless compute + ZFS + NVIDIA container
        ├── default.nix
        └── hardware-configuration.nix
```

## Adding a New Machine

1. **Generate hardware configuration:**
   ```bash
   sudo nixos-generate-config --dir /tmp/new-machine
   ```

2. **Create host directory:**
   ```bash
   mkdir hosts/new-machine-name
   cp /tmp/new-machine/hardware-configuration.nix hosts/new-machine-name/
   ```

3. **Create host configuration:**
   ```bash
   cp hosts/laptop/default.nix hosts/new-machine-name/
   # Edit the file to set hostname and machine-specific settings
   ```

4. **Add to flake.nix:**
   ```nix
   nixosConfigurations = {
     # ... existing configs
     new-machine-name = nixpkgs.lib.nixosSystem {
       modules = [
         ./base.nix
         ./hosts/new-machine-name
         chaotic.nixosModules.default
       ];
     };
   };
   ```

## Building and Switching

**For current machine:**
```bash
sudo nixos-rebuild switch --flake .#hostname
```

**For remote deployment:**
```bash
nixos-rebuild switch --flake .#hostname --target-host user@hostname --use-remote-sudo
```

**Build without switching (test):**
```bash
sudo nixos-rebuild build --flake .#hostname
```

## Current Machines

- **bfgpu**: High-performance workstation with NVIDIA GPU, full desktop environment (Wayland/GNOME), sunshine streaming server
- **surface**: Microsoft Surface laptop with Surface-specific kernel (stable), NVIDIA GPU support, Firefox, full desktop environment (Wayland/GNOME)  
- **threadripper**: Headless compute box with ZFS pool (Storage), NVIDIA open kernel driver + container toolkit for GPU workloads, Docker with GPU passthrough

## Maintenance Commands

### Updating flake inputs
```bash
nix flake update
```

### List generations
```bash
nix-env --list-generations
```

### Garbage collection
```bash
nix-collect-garbage --delete-old
# or for specific generations
nix-collect-garbage --delete-generations 1 2 3

# Run as sudo to collect additional garbage
sudo nix-collect-garbage -d
```

### Clean boot entries
```bash
sudo /run/current-system/bin/switch-to-configuration boot
```

## Desktop Environment & Features

### Window Manager: Hyprland
- Tiling window manager with Wayland
- Keybindings:
  - `Mod + Enter/T`: Terminal (Alacritty)
  - `Mod + B`: Browser (Brave)
  - `Mod + E`: File Manager (Thunar)
  - `Mod + Space`: Application launcher (Wofi)
  - `Mod + W`: Wallpaper picker
  - `Mod + Escape`: Logout menu
  - `Mod + T`: **Theme switcher**
  - `Mod + N`: Network manager
  - `Mod + S`: Screenshot (with region selection)
  - `Mod + Shift + L`: Lock screen

### Theme System
**Runtime theme switching without rebuilding!**

- **Default theme**: Nord (resets on reboot)
- **Available themes**: Nord, Tokyo Night, Solarized Light/Dark, Catppuccin, Dracula, Gruvbox, One Dark
- **Usage**: Press `Mod + T` to cycle through themes instantly
- **What updates**:
  - Waybar (top bar)
  - Alacritty (new terminals)
  - Wofi (application launcher)
  - btop (system monitor)
- **Persistence**: Themes are temporary overrides - system resets to Nord on reboot

### Status Bar: Waybar
- **Modules (left to right)**: Workspaces → Music (Spotify/YouTube) → Network → Audio → Battery → System tray
- **Interactive elements**:
  - Click network icon → Network manager
  - Music info scrolls when text is long
  - Media controls via mouse clicks/scroll

### Applications & Tools
- **Terminal**: Alacritty with theme support
- **Launcher**: Wofi with drun mode (desktop applications only)
- **File manager**: Thunar
- **Browser**: Brave
- **Media**: Spotify with MPRIS integration
- **System monitoring**: btop with custom themes
- **System info**: Fastfetch
- **Wallpaper**: Dynamic picker with Hyprpaper

### Scripts
Located in `home/scripts/`:
- `theme-switcher.sh`: Runtime theme switching
- `wallpaper-picker.sh`: Wallpaper selection
- `waybar-dynamic.sh`: Dynamic waybar modules
- `init-theme.sh`: Initialize theme system

## Notes

- Each machine needs its own `hardware-configuration.nix` generated by `nixos-generate-config`
- LUKS UUIDs are machine-specific and must be updated in each host config
- User configuration centralized in `home.nix` with modular imports
- The base configuration includes common settings like timezone, locale, and basic services
- Theme files are in `themes/` directory using standardized color scheme format
- All configurations use declarative Nix expressions for reproducibility

## macOS (Home Manager Only)

This flake also defines a standalone macOS Home Manager configuration (no nix-darwin yet). It automatically excludes Linux/Wayland-only modules using `lib.mkIf pkgs.stdenv.isLinux` and conditional imports.

### Activate on macOS (aarch64-darwin)
```bash
# First time build + switch
home-manager switch --flake .#kyle-mac

# Or build only to test evaluation
nix build .#homeConfigurations.kyle-mac.activationPackage
```

### Pattern for Linux-Only Additions
When adding new Wayland / Linux-specific features (e.g. Hyprlock, swaybg, pipewire GUI tools), gate them:
```nix
programs.hyprlock = lib.mkIf pkgs.stdenv.isLinux { enable = true; };
```
Or for imports in `home.nix`:
```nix
imports = [ ./home/programs.nix ]
  ++ lib.optionals pkgs.stdenv.isLinux [ ./home/hyprland.nix ./home/waybar.nix ];
```

### Darwin-Specific Packages
Add macOS-only tools under:
```nix
home.packages = with pkgs; [
  # cross-platform
  git vim curl wget jq
] ++ lib.optionals pkgs.stdenv.isDarwin [ coreutils gnu-tar gnu-sed gnu-getopt gnupg pinentry-mac ];
```

### What Is Skipped On macOS
- Hyprland, Waybar, Mako
- Linux-only scripts (wallpaper picker, theme picker, logout menu)
- Brightness / screenshot utilities (grim, slurp, brightnessctl)

### Migrating to nix-darwin Later
You can wrap `homeConfigurations.kyle-mac` into a nix-darwin configuration by adding a `darwinConfigurations` entry and passing the Home Manager module; current gating logic will still work.

### Troubleshooting
- If evaluation fails complaining about a Linux package, ensure it is inside a `lib.mkIf pkgs.stdenv.isLinux` or `lib.optionals pkgs.stdenv.isLinux`.
- For font issues, install Nerd Fonts via Homebrew or a nix derivation and adjust Alacritty config.
- Restart affected apps after switching (Home Manager does not auto-reload them on macOS).
